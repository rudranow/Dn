<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #f39c12; --red: #d63031; --green: #27ae60; --glass: rgba(255, 255, 255, 0.9); }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; }
        
        .bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: url('bg.jpg') no-repeat center 15%; background-size: cover; }
        .bg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(35px); -webkit-mask-image: radial-gradient(circle at center 30%, transparent 5%, black 85%); }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: all 0.5s ease; opacity: 0; transform: translateX(30px); pointer-events: none; display: flex; flex-direction: column; }
        #home { opacity: 1; transform: translateX(0); pointer-events: auto; }
        .screen.active { opacity: 1; transform: translateX(0); pointer-events: auto; z-index: 10; }

        header { background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; text-align: center; font-weight: 600; font-size: 20px; position: relative; }
        .back-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 32px; padding: 0 15px; cursor: pointer; color: var(--accent); }

        .home-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .home-title { color: white; font-size: 36px; text-align: center; margin-bottom: 50px; text-shadow: 0 4px 15px rgba(0,0,0,1); }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 90%; }
        .tile { background: var(--glass); padding: 40px 10px; border-radius: 30px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; padding: 25px; width: 90%; max-width: 400px; border-radius: 20px; text-align: center; }
        .modal input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 18px; text-align: center; }
        .m-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btns button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }

        /* Calculator Styles */
        .calc-display { height: 120px; background: #000; color: #39ff14; font-size: 50px; text-align: right; padding: 35px 20px; font-family: monospace; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #1a1a1a; flex-grow: 1; }
        .calc-btn { background: #333; color: white; border: none; border-radius: 15px; font-size: 24px; cursor: pointer; }
        .calc-btn:active { background: #555; }

        .total-debt-box { position: fixed; bottom: 30px; left: 20px; background: white; color: var(--red); padding: 12px 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-weight: bold; z-index: 50; border: 2px solid var(--red); }
        .item-list { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 110px; }
        .row { background: white; padding: 18px; margin-bottom: 12px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        #slipTemplate { position: absolute; left: -9999px; width: 450px; background: white; padding: 30px; color: black; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 35px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 60; }
    </style>
</head>
<body>

    <div class="bg-container"><div class="bg-overlay"></div></div>

    <div id="customModal" class="modal-overlay">
        <div class="modal">
            <h3 id="mTitle" style="margin-top:0;">‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</h3>
            <div id="mBody" style="margin-bottom:15px;"></div>
            <div id="mInputs"></div>
            <div class="m-btns">
                <button id="mCancel" style="background:#eee;">‡§™‡•Ä‡§õ‡•á</button>
                <button id="mConfirm" style="background:var(--primary); color:white;">‡§†‡•Ä‡§ï ‡§π‡•à</button>
            </div>
        </div>
    </div>

    <div id="slipTemplate">
        <h1 style="text-align:center; margin:0;">‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™</h1>
        <p style="text-align:center; border-bottom:2px dashed #000; padding-bottom:10px;">‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡§∏‡•Ä‡§¶</p>
        <p><b>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï:</b> <span id="sName"></span></p>
        <p><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> <span id="sDate"></span></p>
        <table style="width:100%; border-collapse: collapse; margin: 20px 0;">
            <thead><tr style="background:#f2f2f2;"><th style="border:1px solid #ddd; padding:10px; text-align:left;">‡§µ‡§ø‡§µ‡§∞‡§£</th><th style="border:1px solid #ddd; padding:10px; text-align:right;">‡§∞‡§æ‡§∂‡§ø</th></tr></thead>
            <tbody id="sTableBody"></tbody>
        </table>
        <h2 style="text-align:right;">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ‚Çπ <span id="sTotal"></span></h2>
    </div>

    <div id="home" class="screen">
        <div class="home-content">
            <h1 class="home-title">‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™<br><span style="font-size:16px; opacity:0.7;">‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§ñ‡§æ‡§§‡§æ ‡§¨‡•Å‡§ï</span></h1>
            <div class="home-grid">
                <div class="tile" onclick="openScreen('udhari')"><i>üìñ</i><strong>‡§ñ‡§æ‡§§‡§æ ‡§¨‡•Å‡§ï</strong></div>
                <div class="tile" onclick="openScreen('calculator')"><i>üßÆ</i><strong>‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</strong></div>
            </div>
        </div>
    </div>

    <div id="udhari" class="screen" style="background: #f8f9fa;">
        <header><span class="back-btn" onclick="openScreen('home')">‚Üê</span> ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</header>
        <div style="padding:15px"><input type="text" id="search" placeholder="üîç ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="drawCustomers()" style="width:100%; padding:14px; border-radius:15px; border:none; outline:none; box-shadow: 0 4px 10px rgba(0,0,0,0.05);"></div>
        <div id="customerList" class="item-list"></div>
        <div class="total-debt-box">‡§ï‡•Å‡§≤ ‡§ã‡§£: ‚Çπ <span id="globalDebt">0</span></div>
        <button class="fab" onclick="addNewCustomer()">+</button>
    </div>

    <div id="details" class="screen" style="background: white;">
        <header><span class="back-btn" onclick="openScreen('udhari')">‚Üê</span> <span id="activeCustName">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</span></header>
        <div style="padding:30px; text-align:center; border-bottom:1px solid #f0f0f0;">
            <div style="font-size:14px; color:gray;">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø</div>
            <div id="activeBalance" style="font-size:45px; font-weight:600;">‚Çπ 0</div>
        </div>
        <div id="txHistory" class="item-list"></div>
        <div style="padding:15px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <button onclick="addTx(true)" style="padding:18px; border:none; border-radius:12px; background:var(--red); color:white; font-weight:bold;">‡§â‡§ß‡§æ‡§∞ (+)</button>
            <button onclick="addTx(false)" style="padding:18px; border:none; border-radius:12px; background:var(--green); color:white; font-weight:bold;">‡§ú‡§Æ‡§æ (-)</button>
        </div>
        <button onclick="initSlipFlow()" style="margin: 0 15px 25px; padding:12px; border:1px solid #ddd; border-radius:10px; background:white; font-weight:bold; color:var(--primary);">üìÑ ‡§∞‡§∏‡•Ä‡§¶ ‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
    </div>

    <div id="calculator" class="screen">
        <header><span class="back-btn" onclick="openScreen('home')">‚Üê</span> ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</header>
        <div class="calc-display" id="cDisplay">0</div>
        <div class="calc-grid">
            <button class="calc-btn" onclick="cCl()" style="color:var(--red)">AC</button>
            <button class="calc-btn" onclick="cIn('/')">√∑</button>
            <button class="calc-btn" onclick="cIn('*')">√ó</button>
            <button class="calc-btn" onclick="cIn('-')">-</button>
            <button class="calc-btn" onclick="cIn('7')">7</button>
            <button class="calc-btn" onclick="cIn('8')">8</button>
            <button class="calc-btn" onclick="cIn('9')">9</button>
            <button class="calc-btn" onclick="cIn('+')">+</button>
            <button class="calc-btn" onclick="cIn('4')">4</button>
            <button class="calc-btn" onclick="cIn('5')">5</button>
            <button class="calc-btn" onclick="cIn('6')">6</button>
            <button class="calc-btn" onclick="cEv()" style="background:var(--accent); grid-row: span 2;">=</button>
            <button class="calc-btn" onclick="cIn('1')">1</button>
            <button class="calc-btn" onclick="cIn('2')">2</button>
            <button class="calc-btn" onclick="cIn('3')">3</button>
            <button class="calc-btn" onclick="cIn('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn" onclick="cIn('.')">.</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('shreeji_v5')) || [];
        let curIdx = -1;

        function openScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'udhari') drawCustomers();
        }

        function myModal(title, body, inputs, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('mTitle').innerText = title;
            document.getElementById('mBody').innerText = body;
            const container = document.getElementById('mInputs');
            container.innerHTML = "";
            inputs.forEach(inp => {
                const i = document.createElement('input');
                i.placeholder = inp.p; i.type = inp.t || "text"; i.id = "mi_" + inp.id;
                container.appendChild(i);
            });
            modal.style.display = 'flex';
            document.getElementById('mConfirm').onclick = () => {
                let res = {};
                inputs.forEach(inp => res[inp.id] = document.getElementById("mi_" + inp.id).value);
                modal.style.display = 'none';
                callback(true, res);
            };
            document.getElementById('mCancel').onclick = () => { modal.style.display = 'none'; callback(false); };
        }

        function addNewCustomer() {
            myModal("‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï", "‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç", [{id:'n', p:'‡§®‡§æ‡§Æ'}, {id:'p', p:'‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞', t:'number'}], (ok, res) => {
                if(ok && res.n) { db.push({name: res.n, phone: res.p || "", tx: []}); save(); drawCustomers(); }
            });
        }

        function drawCustomers() {
            const list = document.getElementById('customerList');
            const q = document.getElementById('search').value.toLowerCase();
            let totalG = 0; list.innerHTML = "";
            db.forEach((c, i) => {
                let bal = c.tx.reduce((a, t) => a + (t.isC ? t.amt : -t.amt), 0);
                if(bal > 0) totalG += bal;
                if(c.name.toLowerCase().includes(q)) {
                    list.innerHTML += `<div class="row" onclick="viewCust(${i})">
                        <div><b>${c.name}</b><br><small>${c.phone || '‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç'}</small></div>
                        <b style="color:${bal>=0?'var(--red)':'var(--green)'};">‚Çπ${Math.abs(bal)} ${bal>=0?'‡§¨‡§æ‡§ï‡•Ä':'‡§ú‡§Æ‡§æ'}</b>
                    </div>`;
                }
            });
            document.getElementById('globalDebt').innerText = totalG;
        }

        function viewCust(i) { curIdx = i; document.getElementById('activeCustName').innerText = db[i].name; drawTx(); openScreen('details'); }

        function addTx(isC) {
            myModal(isC ? "‡§â‡§ß‡§æ‡§∞" : "‡§ú‡§Æ‡§æ", "‡§∞‡§ï‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç", [{id:'a', p:'‚Çπ 0', t:'number'}], (ok, res) => {
                if(ok && res.a) {
                    db[curIdx].tx.push({ amt: parseFloat(res.a), isC, time: new Date().toLocaleString('hi-IN', {dateStyle:'short', timeStyle:'short'}) });
                    save(); drawTx();
                }
            });
        }

        function drawTx() {
            const h = document.getElementById('txHistory');
            let bal = db[curIdx].tx.reduce((a, t) => a + (t.isC ? t.amt : -t.amt), 0);
            document.getElementById('activeBalance').innerText = "‚Çπ " + Math.abs(bal);
            document.getElementById('activeBalance').style.color = bal >= 0 ? 'var(--red)' : 'var(--green)';
            h.innerHTML = db[curIdx].tx.slice().reverse().map(t => `<div class="row">
                <div><small>${t.time}</small><br><b>${t.isC?'‡§â‡§ß‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ':'‡§ú‡§Æ‡§æ ‡§Æ‡§ø‡§≤‡§æ'}</b></div>
                <b style="color:${t.isC?'var(--red)':'var(--green)'};">‚Çπ${t.amt}</b>
            </div>`).join('');
        }

        function initSlipFlow() {
            myModal("‡§∞‡§∏‡•Ä‡§¶", "‡§ï‡•ç‡§Ø‡§æ ‡§∞‡§∏‡•Ä‡§¶ ‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [], (ok) => { if(ok) generateSlip(); });
        }

        function generateSlip() {
            const c = db[curIdx];
            let tempBal = 0, lastZeroIdx = -1;
            c.tx.forEach((t, i) => { tempBal += (t.isC ? t.amt : -t.amt); if(tempBal === 0) lastZeroIdx = i; });
            let txToPrint = c.tx.slice(lastZeroIdx + 1);
            if(txToPrint.length === 0) txToPrint = c.tx;

            document.getElementById('sName').innerText = c.name;
            document.getElementById('sDate').innerText = new Date().toLocaleDateString('hi-IN');
            let balText = document.getElementById('activeBalance').innerText;
            document.getElementById('sTotal').innerText = balText.replace('‚Çπ ','');
            
            document.getElementById('sTableBody').innerHTML = txToPrint.map(t => `
                <tr><td style="border:1px solid #ddd; padding:10px;">${t.time} (${t.isC?'‡§â‡§ß‡§æ‡§∞':'‡§ú‡§Æ‡§æ'})</td>
                <td style="border:1px solid #ddd; padding:10px; text-align:right; color:${t.isC?'red':'green'};">‚Çπ${t.amt}</td></tr>`).join('');

            html2canvas(document.getElementById('slipTemplate')).then(canvas => {
                const img = canvas.toDataURL("image/jpeg");
                const link = document.createElement('a');
                link.download = `Shreeji_${c.name}.jpg`; link.href = img; link.click();
                
                setTimeout(() => {
                    myModal("WhatsApp", "‡§ï‡•ç‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§∞‡§∏‡•Ä‡§¶ ‡§ï‡§æ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§≠‡•á‡§ú‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [], (send) => {
                        if(send) {
                            let msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${c.name}, ‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™ ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‚Çπ${document.getElementById('sTotal').innerText} ‡§π‡•à‡•§ ‡§∞‡§∏‡•Ä‡§¶ ‡§´‡•ã‡§ü‡•ã ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§∏‡•á ‡§≠‡•á‡§ú‡•á‡§Ç‡•§`;
                            window.open(`https://wa.me/${c.phone ? '91'+c.phone : ''}?text=${encodeURIComponent(msg)}`, '_blank');
                        }
                    });
                }, 1000);
            });
        }

        function save() { localStorage.setItem('shreeji_v5', JSON.stringify(db)); }
        
        let cV = "";
        function cIn(v) { cV += v; document.getElementById('cDisplay').innerText = cV; }
        function cCl() { cV = ""; document.getElementById('cDisplay').innerText = "0"; }
        function cEv() { try { cV = eval(cV).toString(); document.getElementById('cDisplay').innerText = cV; } catch { cCl(); } }
    </script>
</body>
</html>
