<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #f39c12; --red: #d63031; --green: #27ae60; --glass: rgba(255, 255, 255, 0.9); }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; }
        
        .bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: url('bg.jpg') no-repeat center 15%; background-size: cover; }
        .bg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(35px); -webkit-mask-image: radial-gradient(circle at center 30%, transparent 5%, black 85%); }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: all 0.5s ease; opacity: 0; transform: translateX(30px); pointer-events: none; display: flex; flex-direction: column; }
        #home { opacity: 1; transform: translateX(0); pointer-events: auto; }
        .screen.active { opacity: 1; transform: translateX(0); pointer-events: auto; z-index: 10; }

        header { background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; text-align: center; font-weight: 600; font-size: 20px; position: relative; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .back-btn { position: absolute; left: 10px; font-size: 32px; padding: 0 15px; cursor: pointer; color: var(--accent); }
        .header-actions { position: absolute; right: 10px; display: flex; gap: 15px; }
        .act-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: white; padding: 5px; }

        .home-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .home-title { color: white; font-size: 36px; text-align: center; margin-bottom: 50px; text-shadow: 0 4px 15px rgba(0,0,0,1); }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 90%; }
        .tile { background: var(--glass); padding: 40px 10px; border-radius: 30px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        /* Modal & Dialogs */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
        
        .modal { background: white; width: 95%; max-width: 450px; border-radius: 20px; display: flex; flex-direction: column; height: 90vh; max-height: 800px; overflow: hidden; position: relative; }
        
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .modal-header h3 { margin: 0; }
        
        .modal-body { padding: 15px; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        
        .modal-footer { border-top: 1px solid #eee; padding: 15px; display: flex; gap: 10px; flex-shrink: 0; background: white; }
        .modal-footer button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 16px; }

        /* Modified Input Styles */
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; text-align: center; }
        
        .styled-input { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 10px; outline: none; transition: 0.3s; }
        .styled-input:focus { border-color: var(--accent); }

        /* Suggestions Box */
        .suggestions-list {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: white; border: 1px solid #ddd; border-radius: 0 0 10px 10px;
            max-height: 200px; overflow-y: auto; z-index: 100;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #f5f5f5; cursor: pointer; font-size: 14px; }
        .suggestion-item:hover { background: #f9f9f9; }

        /* Add Button */
        .add-item-btn { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 80px; margin-left: 10px; flex-shrink: 0; }
        
        /* Translucent Box Style */
        .cart-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; min-height: 50px; }
        .cart-tag {
            background: rgba(44, 62, 80, 0.1);
            border: 1px solid rgba(44, 62, 80, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex; align-items: center; gap: 10px;
            font-size: 14px; color: #333;
            animation: fadeIn 0.3s ease;
        }
        .tag-remove { 
            background: rgba(214, 48, 49, 0.15); color: var(--red); 
            width: 22px; height: 22px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Contact Picker Button */
        .contact-btn { position: absolute; right: 5px; top: 5px; bottom: 5px; background: var(--accent); border: none; border-radius: 8px; width: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }

        /* General UI */
        .calc-display { height: 120px; background: #000; color: #39ff14; font-size: 50px; text-align: right; padding: 35px 20px; font-family: monospace; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #1a1a1a; flex-grow: 1; }
        .calc-btn { background: #333; color: white; border: none; border-radius: 15px; font-size: 24px; cursor: pointer; }
        .calc-btn:active { background: #555; }
        .total-debt-box { position: fixed; bottom: 30px; left: 20px; background: white; color: var(--red); padding: 12px 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-weight: bold; z-index: 50; border: 2px solid var(--red); }
        .item-list { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 110px; }
        .row { background: white; padding: 18px; margin-bottom: 12px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        #slipTemplate { position: absolute; left: -9999px; width: 450px; background: white; padding: 30px; color: black; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 35px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 60; }
        
        #customModal .modal { height: auto; } 
    </style>
</head>
<body>

    <div class="bg-container"><div class="bg-overlay"></div></div>

    <div id="customModal" class="modal-overlay">
        <div class="modal" style="text-align:center;">
            <div class="modal-header">
                <h3 id="mTitle">‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</h3>
            </div>
            <div class="modal-body">
                <div id="mBody" style="margin-bottom:15px;"></div>
                <div id="mInputs" style="position:relative;"></div>
            </div>
            <div class="modal-footer">
                <button id="mCancel" style="background:#eee;">‡§™‡•Ä‡§õ‡•á</button>
                <button id="mConfirm" style="background:var(--primary); color:white;">‡§†‡•Ä‡§ï ‡§π‡•à</button>
            </div>
        </div>
    </div>

    <div id="itemEntryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
            </div>
            
            <div class="modal-body" style="display:flex; flex-direction:column;">
                
                <div style="display:flex; align-items:flex-end;">
                    <div class="input-group" style="flex-grow:1; margin-bottom:0;">
                        <label>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ (Item Name)</label>
                        <input type="text" id="itemName" class="styled-input" placeholder="‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." oninput="handleItemSearch(this.value)" autocomplete="off">
                        <div id="suggestionBox" class="suggestions-list"></div>
                    </div>
                    <button class="add-item-btn" onclick="addCurrentItem()">+ Add</button>
                </div>

                <div style="margin-top:20px; margin-bottom:10px; font-size:12px; color:#666;">‡§ö‡•Å‡§®‡•á ‡§ó‡§è ‡§∏‡§æ‡§Æ‡§æ‡§®:</div>
                <div class="cart-container" id="cartList">
                    <div style="width:100%; text-align:center; color:#ccc; padding:10px;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç</div>
                </div>

                <div style="flex-grow:1;"></div>

                <div style="border-top:1px dashed #ddd; padding-top:20px; margin-top:10px;">
                    <div class="input-group">
                        <label style="font-size:14px; color:var(--red); font-weight:bold;">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø (Total Price)</label>
                        <input type="number" id="finalPrice" class="styled-input" style="border-color:var(--primary); font-weight:bold; font-size:22px; text-align:center;" placeholder="‚Çπ 0" inputmode="numeric">
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button onclick="closeItemModal()" style="background:#eee;">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                <button onclick="saveCartTx()" style="background:var(--green); color:white;">‚úì ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>

    <div id="billViewModal" class="modal-overlay">
        <div class="modal" style="height:auto; max-height:80vh;">
            <div class="modal-header"><h3>‡§¨‡§ø‡§≤ ‡§µ‡§ø‡§µ‡§∞‡§£</h3></div>
            <div class="modal-body">
                <div id="billList" style="padding:10px;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="document.getElementById('billViewModal').style.display='none'" style="background:var(--primary); color:white;">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>

    <div id="slipTemplate">
        <h1 style="text-align:center; margin:0;">‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™</h1>
        <p style="text-align:center; border-bottom:2px dashed #000; padding-bottom:10px;">‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡§∏‡•Ä‡§¶</p>
        <p><b>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï:</b> <span id="sName"></span></p>
        <p><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> <span id="sDate"></span></p>
        <table style="width:100%; border-collapse: collapse; margin: 20px 0;">
            <thead><tr style="background:#f2f2f2;"><th style="border:1px solid #ddd; padding:10px; text-align:left;">‡§µ‡§ø‡§µ‡§∞‡§£</th><th style="border:1px solid #ddd; padding:10px; text-align:right;">‡§∞‡§æ‡§∂‡§ø</th></tr></thead>
            <tbody id="sTableBody"></tbody>
        </table>
        <h2 style="text-align:right;">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ‚Çπ <span id="sTotal"></span></h2>
    </div>

    <div id="home" class="screen">
        <div class="home-content">
            <h1 class="home-title">‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™<br><span style="font-size:16px; opacity:0.7;">‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§ñ‡§æ‡§§‡§æ ‡§¨‡•Å‡§ï</span></h1>
            <div class="home-grid">
                <div class="tile" onclick="openScreen('udhari')"><i>üìñ</i><strong>‡§ñ‡§æ‡§§‡§æ ‡§¨‡•Å‡§ï</strong></div>
                <div class="tile" onclick="openScreen('calculator')"><i>üßÆ</i><strong>‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</strong></div>
            </div>
        </div>
    </div>

    <div id="udhari" class="screen" style="background: #f8f9fa;">
        <header><span class="back-btn" onclick="openScreen('home')">‚Üê</span> ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</header>
        <div style="padding:15px"><input type="text" id="search" placeholder="üîç ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="drawCustomers()" style="width:100%; padding:14px; border-radius:15px; border:none; outline:none; box-shadow: 0 4px 10px rgba(0,0,0,0.05);"></div>
        <div id="customerList" class="item-list"></div>
        <div class="total-debt-box">‡§ï‡•Å‡§≤ ‡§ã‡§£: ‚Çπ <span id="globalDebt">0</span></div>
        <button class="fab" onclick="addNewCustomer()">+</button>
    </div>

    <div id="details" class="screen" style="background: white;">
        <header>
            <span class="back-btn" onclick="openScreen('udhari')">‚Üê</span> 
            <span id="activeCustName" style="flex-grow:1; margin-left:40px; text-align:left;">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</span>
            <div class="header-actions">
                <button class="act-btn" onclick="clearCustHistory()" title="‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç">üóëÔ∏è</button>
                <button class="act-btn" onclick="deleteCust()" style="color:var(--red);" title="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§è‡§Ç">‚úñ</button>
            </div>
        </header>
        <div style="padding:30px; text-align:center; border-bottom:1px solid #f0f0f0;">
            <div style="font-size:14px; color:gray;">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø</div>
            <div id="activeBalance" style="font-size:45px; font-weight:600;">‚Çπ 0</div>
        </div>
        <div id="txHistory" class="item-list"></div>
        <div style="padding:15px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <button onclick="openItemEntry()" style="padding:18px; border:none; border-radius:12px; background:var(--red); color:white; font-weight:bold;">‡§â‡§ß‡§æ‡§∞ (+)</button>
            <button onclick="addTx(false)" style="padding:18px; border:none; border-radius:12px; background:var(--green); color:white; font-weight:bold;">‡§ú‡§Æ‡§æ (-)</button>
        </div>
        <div style="display:flex; gap:10px; padding:0 15px 25px;">
            <button onclick="initSlipFlow()" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:10px; background:white; font-weight:bold; color:var(--primary);">üìÑ ‡§∞‡§∏‡•Ä‡§¶ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
            <button onclick="shareOnWhatsapp()" style="flex:1; padding:12px; border:none; border-radius:10px; background:#25D366; font-weight:bold; color:white;">üí¨ WhatsApp ‡§≠‡•á‡§ú‡•á‡§Ç</button>
        </div>
    </div>

    <div id="calculator" class="screen">
        <header><span class="back-btn" onclick="openScreen('home')">‚Üê</span> ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</header>
        <div class="calc-display" id="cDisplay">0</div>
        <div class="calc-grid">
            <button class="calc-btn" onclick="cCl()" style="color:var(--red)">AC</button>
            <button class="calc-btn" onclick="cIn('/')">√∑</button>
            <button class="calc-btn" onclick="cIn('*')">√ó</button>
            <button class="calc-btn" onclick="cIn('-')">-</button>
            <button class="calc-btn" onclick="cIn('7')">7</button>
            <button class="calc-btn" onclick="cIn('8')">8</button>
            <button class="calc-btn" onclick="cIn('9')">9</button>
            <button class="calc-btn" onclick="cIn('+')">+</button>
            <button class="calc-btn" onclick="cIn('4')">4</button>
            <button class="calc-btn" onclick="cIn('5')">5</button>
            <button class="calc-btn" onclick="cIn('6')">6</button>
            <button class="calc-btn" onclick="cEv()" style="background:var(--accent); grid-row: span 2;">=</button>
            <button class="calc-btn" onclick="cIn('1')">1</button>
            <button class="calc-btn" onclick="cIn('2')">2</button>
            <button class="calc-btn" onclick="cIn('3')">3</button>
            <button class="calc-btn" onclick="cIn('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn" onclick="cIn('.')">.</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('shreeji_v5')) || [];
        let curIdx = -1;
        
        // --- Product List Management (Dynamic) ---
        const defaultProducts = [
            "Biscuit ‚Äì Biskut", "Chocolate ‚Äì Chocolate", "Chips ‚Äì Chips", "Namkeen ‚Äì Namkeen",
            "Rice ‚Äì Chawal", "Flour ‚Äì Aata", "Oil ‚Äì Tel", "Soap ‚Äì Sabun", "Shampoo ‚Äì Shampoo",
            "Toothpaste ‚Äì Toothpaste", "Detergent ‚Äì Detergent", "Noodles ‚Äì Noodles", "Pasta ‚Äì Pasta",
            "Bread ‚Äì Bread", "Milk ‚Äì Doodh", "Cheese ‚Äì Cheese", "Butter ‚Äì Butter", "Yogurt ‚Äì Dahi",
            "Tea ‚Äì Chai", "Coffee ‚Äì Coffee", "Sugar ‚Äì Cheeni", "Salt ‚Äì Namak", "Spices ‚Äì Masale",
            "Pickle ‚Äì Achar", "Sauce ‚Äì Sauce", "Ketchup ‚Äì Ketchup", "Jam ‚Äì Jam", "Honey ‚Äì Shahad",
            "Cake ‚Äì Cake", "Icecream ‚Äì Icecream", "Snacks ‚Äì Snacks", "Sweets ‚Äì Mithai",
            "Dryfruits ‚Äì SookheMewa", "Pulses ‚Äì Dal", "Lentils ‚Äì Dal", "Cereals ‚Äì Anaj",
            "Juice ‚Äì Juice", "Softdrink ‚Äì ColdDrink", "Water ‚Äì Paani", "Floorcleaner ‚Äì FloorCleaner",
            "Dishwash ‚Äì BartanLiquid", "Tissue ‚Äì Tissue", "Napkin ‚Äì Napkin", "Candles ‚Äì Mombatti",
            "Matches ‚Äì Maachis", "Batteries ‚Äì Cell", "Soapbar ‚Äì NahaneKaSabun", "Handwash ‚Äì Handwash",
            "Facewash ‚Äì Facewash", "Hairoil ‚Äì BaalTel", "Cream ‚Äì Cream", "Lotion ‚Äì Lotion",
            "Deodorant ‚Äì Deo", "Perfume ‚Äì Perfume", "Powder ‚Äì Powder", "Biscuitsnacks ‚Äì NamkeenBiskut",
            "Chocolatesweets ‚Äì ChocolateMithai", "Readyfood ‚Äì ReadyKhana", "Frozenfood ‚Äì FrozenKhana",
            "Bakeryitems ‚Äì BakerySamaan"
        ];
        
        // Load saved products or use default
        let productList = JSON.parse(localStorage.getItem('shreeji_products')) || defaultProducts;

        // Temporary storage for item names only
        let tempItemNames = [];

        function openScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'udhari') drawCustomers();
        }

        // --- NEW SEARCH & ITEM LOGIC ---
        function handleItemSearch(val) {
            const box = document.getElementById('suggestionBox');
            if(!val) { box.style.display = 'none'; return; }
            
            const matches = productList.filter(item => item.toLowerCase().includes(val.toLowerCase()));
            
            if(matches.length > 0) {
                box.innerHTML = matches.map(m => 
                    `<div class="suggestion-item" onclick="selectSuggestion('${m}')">${m}</div>`
                ).join('');
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        }

        function selectSuggestion(name) {
            document.getElementById('itemName').value = name;
            document.getElementById('suggestionBox').style.display = 'none';
            addCurrentItem();
        }

        function openItemEntry() {
            tempItemNames = []; // Reset list
            document.getElementById('itemName').value = "";
            document.getElementById('finalPrice').value = "";
            document.getElementById('suggestionBox').style.display = 'none';
            updateCartUI();
            document.getElementById('itemEntryModal').style.display = 'flex';
            document.getElementById('itemName').focus();
        }

        function closeItemModal() {
            document.getElementById('itemEntryModal').style.display = 'none';
        }

        function addCurrentItem() {
            const input = document.getElementById('itemName');
            const val = input.value.trim();
            if(!val) return;

            // Learn new item logic
            if(!productList.includes(val)) {
                productList.push(val);
                localStorage.setItem('shreeji_products', JSON.stringify(productList));
            }

            tempItemNames.push(val);
            input.value = "";
            document.getElementById('suggestionBox').style.display = 'none';
            input.focus();
            updateCartUI();
        }

        function removeName(i) {
            tempItemNames.splice(i, 1);
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cartList');
            if(tempItemNames.length === 0) {
                list.innerHTML = '<div style="width:100%; text-align:center; color:#ccc; padding:10px;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç</div>';
                return;
            }
            // Translucent box with Cross styling - Only Names
            list.innerHTML = tempItemNames.map((name, i) => `
                <div class="cart-tag">
                    ${name}
                    <span class="tag-remove" onclick="removeName(${i})">√ó</span>
                </div>
            `).join('');
        }

        function saveCartTx() {
            // Case 1: No items added -> Direct Amount Fallback
            if(tempItemNames.length === 0) {
                // If text is in input but not added
                const pending = document.getElementById('itemName').value.trim();
                if(pending) {
                    addCurrentItem();
                    setTimeout(saveCartTx, 100);
                    return;
                }
                
                closeItemModal();
                // Open fallback modal
                myModal("‡§∏‡•Ä‡§ß‡•á ‡§∞‡§ï‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", "‡§ï‡•ã‡§à ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§∏‡•á‡§≤‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•Ä‡§ß‡•á ‡§∞‡§ï‡§Æ (Amount) ‡§°‡§æ‡§≤‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [{id:'amt', p:'‡§∞‡§æ‡§∂‡§ø (‚Çπ)', t:'number'}], (ok, res) => {
                    if(ok && res.amt) {
                        pushTransaction(parseFloat(res.amt), true, []);
                    } else {
                        // If cancelled, reopen item modal
                        openItemEntry();
                    }
                });
                return;
            }

            // Case 2: Items added -> Validate Total Price
            const priceVal = document.getElementById('finalPrice').value;
            if(!priceVal) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø (Total Price) ‡§≠‡§∞‡•á‡§Ç"); document.getElementById('finalPrice').focus(); return; }
            
            const totalAmt = parseFloat(priceVal);
            pushTransaction(totalAmt, true, tempItemNames);
            closeItemModal();
        }

        function pushTransaction(amt, isC, itemsArr) {
            // itemsArr is array of strings (names)
            db[curIdx].tx.push({ 
                amt: amt, 
                isC: isC, 
                time: new Date().toLocaleString('hi-IN', {dateStyle:'short', timeStyle:'short'}),
                items: itemsArr // Store array of strings
            });
            save(); 
            drawTx();
        }

        // --- Generic Modal & Contact Picker ---
        function myModal(title, body, inputs, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('mTitle').innerText = title;
            document.getElementById('mBody').innerText = body;
            const container = document.getElementById('mInputs');
            container.innerHTML = "";
            inputs.forEach(inp => {
                const div = document.createElement('div');
                div.style.position = 'relative';
                
                const i = document.createElement('input');
                i.placeholder = inp.p; i.type = inp.t || "text"; i.id = "mi_" + inp.id;
                i.style.width="100%"; i.style.padding="15px"; i.style.border="1px solid #ddd"; i.style.borderRadius="12px"; i.style.marginBottom="10px";
                if(inp.t === 'number') i.inputMode = "numeric";
                div.appendChild(i);

                if(inp.id === 'p') {
                    const btn = document.createElement('button');
                    btn.innerHTML = 'üìû';
                    btn.className = 'contact-btn';
                    btn.onclick = async () => {
                        try {
                            const contacts = await navigator.contacts.select(['tel'], { multiple: false });
                            if(contacts.length && contacts[0].tel.length) {
                                i.value = contacts[0].tel[0].replace(/\D/g,'').slice(-10);
                            }
                        } catch(e) { alert("‡§ï‡§æ‡§Ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡•Å‡§≤ ‡§∏‡§ï‡•Ä‡•§ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§"); }
                    };
                    div.appendChild(btn);
                }
                container.appendChild(div);
            });
            modal.style.display = 'flex';
            document.getElementById('mConfirm').onclick = () => {
                let res = {};
                inputs.forEach(inp => res[inp.id] = document.getElementById("mi_" + inp.id).value);
                modal.style.display = 'none';
                callback(true, res);
            };
            document.getElementById('mCancel').onclick = () => { modal.style.display = 'none'; callback(false); };
        }

        function showTxDetails(txIdx) {
            const tx = db[curIdx].tx[txIdx];
            const modal = document.getElementById('billViewModal');
            
            let content = "";
            if(tx.items && tx.items.length > 0) {
                // FIXED: Handle Objects in items array
                content = `<b>‡§∏‡§æ‡§Æ‡§æ‡§®:</b><br>` + tx.items.map(item => {
                    let dName = (typeof item === 'object' && item !== null) ? (item.name || item.item || 'Unknown') : item;
                    return `<div style="padding:8px; border-bottom:1px dashed #eee;">${dName}</div>`;
                }).join('');
            } else {
                content = `<div style="padding:20px; text-align:center; color:#666;">‡§∏‡•Ä‡§ß‡•á ‡§∞‡§ï‡§Æ ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à</div>`;
            }
            
            document.getElementById('billList').innerHTML = content + 
                `<div style="text-align:right; padding-top:15px; font-size:22px; color:${tx.isC?'var(--red)':'var(--green)'};"><b>${tx.isC?'‡§â‡§ß‡§æ‡§∞':'‡§ú‡§Æ‡§æ'}: ‚Çπ${tx.amt}</b></div>`;
            
            modal.style.display = 'flex';
        }

        function addNewCustomer() {
            myModal("‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï", "‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç", [{id:'n', p:'‡§®‡§æ‡§Æ'}, {id:'p', p:'‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞', t:'number'}], (ok, res) => {
                if(ok && res.n) { db.push({name: res.n, phone: res.p || "", tx: []}); save(); drawCustomers(); }
            });
        }

        function deleteCust() {
            myModal("‡§∏‡§æ‡§µ‡§ß‡§æ‡§®", "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [], (ok) => {
                if(ok) { db.splice(curIdx, 1); save(); openScreen('udhari'); }
            });
        }

        function clearCustHistory() {
            myModal("‡§∏‡§æ‡§µ‡§ß‡§æ‡§®", "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§æ‡§∞‡§æ ‡§™‡§ø‡§õ‡§≤‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨ (History) ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [], (ok) => {
                if(ok) { db[curIdx].tx = []; save(); drawTx(); }
            });
        }

        function drawCustomers() {
            const list = document.getElementById('customerList');
            const q = document.getElementById('search').value.toLowerCase();
            let totalG = 0; list.innerHTML = "";
            db.forEach((c, i) => {
                let bal = c.tx.reduce((a, t) => a + (t.isC ? t.amt : -t.amt), 0);
                if(bal > 0) totalG += bal;
                if(c.name.toLowerCase().includes(q)) {
                    list.innerHTML += `<div class="row" onclick="viewCust(${i})">
                        <div><b>${c.name}</b><br><small>${c.phone || '‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç'}</small></div>
                        <b style="color:${bal>=0?'var(--red)':'var(--green)'};">‚Çπ${Math.abs(bal)} ${bal>=0?'‡§¨‡§æ‡§ï‡•Ä':'‡§ú‡§Æ‡§æ'}</b>
                    </div>`;
                }
            });
            document.getElementById('globalDebt').innerText = totalG;
        }

        function viewCust(i) { curIdx = i; document.getElementById('activeCustName').innerText = db[i].name; drawTx(); openScreen('details'); }

        function addTx(isC) {
            myModal(isC ? "‡§â‡§ß‡§æ‡§∞" : "‡§ú‡§Æ‡§æ", "‡§∞‡§ï‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç", [{id:'a', p:'‚Çπ 0', t:'number'}], (ok, res) => {
                if(ok && res.a) {
                    pushTransaction(parseFloat(res.a), isC, []);
                }
            });
        }

        function drawTx() {
            const h = document.getElementById('txHistory');
            let bal = 0;
            let rows = db[curIdx].tx.map((t, idx) => {
                bal += (t.isC ? t.amt : -t.amt);
                return { t, idx, hasItems: t.items && t.items.length > 0 };
            });
            document.getElementById('activeBalance').innerText = "‚Çπ " + Math.abs(bal);
            document.getElementById('activeBalance').style.color = bal >= 0 ? 'var(--red)' : 'var(--green)';
            h.innerHTML = rows.slice().reverse().map(obj => `
            <div class="row" onclick="showTxDetails(${obj.idx})" style="cursor:pointer;">
                <div><small>${obj.t.time}</small><br><b>${obj.t.isC ? (obj.hasItems ? '‡§∏‡§æ‡§Æ‡§æ‡§® (‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç)' : '‡§â‡§ß‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ') : '‡§ú‡§Æ‡§æ ‡§Æ‡§ø‡§≤‡§æ'}</b></div>
                <b style="color:${obj.t.isC?'var(--red)':'var(--green)'};">‚Çπ${obj.t.amt}</b>
            </div>`).join('');
        }

        function initSlipFlow() { myModal("‡§∞‡§∏‡•Ä‡§¶", "‡§ï‡•ç‡§Ø‡§æ ‡§∞‡§∏‡•Ä‡§¶ ‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", [], (ok) => { if(ok) generateSlip(); }); }

        function generateSlip() {
            const c = db[curIdx];
            let tempBal = 0, lastZeroIdx = -1;
            c.tx.forEach((t, i) => { tempBal += (t.isC ? t.amt : -t.amt); if(tempBal === 0) lastZeroIdx = i; });
            
            const validTx = c.tx.slice(lastZeroIdx + 1);
            if(validTx.length === 0) { alert("‡§ï‡•ã‡§à ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à"); return; }

            document.getElementById('sName').innerText = c.name;
            document.getElementById('sDate').innerText = new Date().toLocaleDateString('hi-IN');
            
            let html = "", total = 0;
            validTx.forEach(t => {
                total += (t.isC ? t.amt : -t.amt);
                let desc = "";
                if(t.isC) {
                    if(t.items && t.items.length > 0) {
                        // FIXED: Handle [object Object] issue
                        desc = t.items.map(i => (typeof i === 'object' && i !== null) ? (i.name || i.item || '') : i).join(', ');
                    }
                    else desc = "‡§â‡§ß‡§æ‡§∞";
                } else {
                    desc = "‡§ú‡§Æ‡§æ";
                }
                
                const color = t.isC ? 'red' : 'green';
                html += `<tr>
                    <td style="border:1px solid #ddd; padding:10px;">${desc}<br><small>${t.time}</small></td>
                    <td style="border:1px solid #ddd; padding:10px; text-align:right; color:${color}; font-weight:bold;">${t.isC?'':'-'}‚Çπ${t.amt}</td>
                </tr>`;
            });
            document.getElementById('sTableBody').innerHTML = html;
            document.getElementById('sTotal').innerText = total;

            const slip = document.getElementById('slipTemplate');
            html2canvas(slip).then(canvas => {
                const link = document.createElement('a');
                link.download = `Bill_${c.name}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function shareOnWhatsapp() {
            const c = db[curIdx];
            let bal = c.tx.reduce((a, t) => a + (t.isC ? t.amt : -t.amt), 0);
            
            const msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${c.name},%0a‡§∂‡•ç‡§∞‡•Ä‡§ú‡•Ä ‡§Æ‡•á‡§ó‡§æ ‡§∂‡•â‡§™ (‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§ñ‡§æ‡§§‡§æ ‡§¨‡•Å‡§ï)%0a------------------%0a‡§Ü‡§™‡§ï‡§æ ‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§π‡•à: *‚Çπ${bal}*%0a‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`;
            
            if(c.phone && c.phone.length >= 10) {
                // Direct Chat
                window.location.href = `https://wa.me/91${c.phone}?text=${msg}`;
            } else {
                // General Share (Select Contact)
                window.location.href = `whatsapp://send?text=${msg}`;
            }
        }

        function save() { localStorage.setItem('shreeji_v5', JSON.stringify(db)); }
        
        // --- Calculator Logic (Fixed & Completed) ---
        let cExp = "";
        
        function cIn(v) { 
            const d = document.getElementById('cDisplay');
            // Prevent starting with operator
            if(cExp === "" && (v==='/'||v==='*'||v==='+'||v==='-')) return;
            cExp += v;
            d.innerText = cExp;
        }

        function cCl() {
            cExp = "";
            document.getElementById('cDisplay').innerText = "0";
        }

        function cEv() {
            try {
                // Safety check: eval can be risky, but for a simple calc app it's okay.
                const res = eval(cExp); 
                document.getElementById('cDisplay').innerText = res;
                cExp = res.toString();
            } catch(e) {
                document.getElementById('cDisplay').innerText = "Error";
                cExp = "";
            }
        }
    </script>
</body>
</html>
